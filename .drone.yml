---
{"kind": "pipeline", "type": "docker", "name": "coding-standard-php7.4", "workspace": {"base": "/var/www/owncloud", "path": "server/apps/"}, "steps": [{"name": "skip-if-unchanged", "image": "owncloudci/drone-skip-pipeline", "when": {"event": ["pull_request"]}, "settings": {"ALLOW_SKIP_CHANGED": ["^.github/.*", "^changelog/.*", "^docs/.*", "CHANGELOG.md", "CONTRIBUTING.md", "LICENSE", "LICENSE.md", "README.md"]}}, {"name": "coding-standard", "image": "owncloudci/php:7.4", "commands": ["make test-php-style"]}], "depends_on": [], "trigger": {"ref": ["refs/pull/**", "refs/tags/**", "refs/heads/master"]}}
---
{"kind": "pipeline", "type": "docker", "name": "cancel-previous-builds", "clone": {"disable": true}, "steps": [{"name": "cancel-previous-builds", "image": "owncloudci/drone-cancel-previous-builds", "settings": {"DRONE_TOKEN": {"from_secret": "drone_token"}}}], "depends_on": [], "trigger": {"ref": ["refs/pull/**"]}}
---
{"kind": "pipeline", "type": "docker", "name": "check-starlark", "steps": [{"name": "format-check-starlark", "image": "owncloudci/bazel-buildifier", "commands": ["buildifier --mode=check .drone.star"]}, {"name": "show-diff", "image": "owncloudci/bazel-buildifier", "commands": ["buildifier --mode=fix .drone.star", "git diff"], "when": {"status": ["failure"]}}], "depends_on": [], "trigger": {"ref": ["refs/pull/**"]}}
---
{"kind": "pipeline", "type": "docker", "name": "webUIFiles-flaky-chrome-mysql8.0-php7.4", "workspace": {"base": "/var/www/owncloud", "path": "testrunner/apps/"},
 "steps": [
   {
     "name": "install-core",
      "image": "owncloudci/core",
       "settings": {
         "git_reference": "check-scroll-into-menu-flaky",
          "core_path": "/var/www/owncloud/server",
           "db_type": "mysql",
            "db_name": "owncloud",
             "db_host": "mysql",
              "db_username": "owncloud",
               "db_password": "owncloud",
                "exclude": "apps/"
                }
                },
                 {"name": "install-testrunner", "image": "owncloudci/php:7.4", "commands": ["mkdir /tmp/testrunner", "git clone -b check-scroll-into-menu-flaky --depth=1 https://github.com/owncloud/core.git /tmp/testrunner", "rsync -aIX /tmp/testrunner /var/www/owncloud", "cp -r /var/www/owncloud/testrunner/apps/ /var/www/owncloud/server/apps/"]},
                 {"name": "install-federated", "image": "owncloudci/core", "settings": {"git_reference": "check-scroll-into-menu-flaky", "core_path": "/var/www/owncloud/federated", "db_type": "mysql", "db_name": "owncloud-federated", "db_host": "mysql-federated", "db_username": "owncloud", "db_password": "owncloud"}},
                 {"name": "configure-federation", "image": "owncloudci/php:7.4", "commands": ["echo 'export TEST_SERVER_FED_URL=http://federated' > /var/www/owncloud/saved-settings.sh", "cd /var/www/owncloud/federated", "php occ a:l", "php occ a:e testing", "php occ a:l", "php occ config:system:set trusted_domains 1 --value=federated", "php occ log:manage --level 2", "php occ config:list"]},
                 {"name": "owncloud-log-federated", "image": "owncloud/ubuntu:20.04", "detach": true, "commands": ["tail -f /var/www/owncloud/federated/data/owncloud.log"]},
                 {"name": "install-extra-apps", "image": "owncloudci/php:7.4", "commands": ["ls /var/www/owncloud/testrunner/apps/files_external || git clone https://github.com/owncloud/files_external.git /var/www/owncloud/testrunner/apps/files_external", "ls /var/www/owncloud/server/apps/files_external || cp -r /var/www/owncloud/testrunner/apps/files_external /var/www/owncloud/server/apps/", "cd /var/www/owncloud/server", "php occ a:l", "php occ a:e files_external", "php occ a:l"]},
                 {"name": "setup-server-", "image": "owncloudci/php:7.4", "commands": ["cd /var/www/owncloud/server", "php occ a:l", "php occ a:e ", "php occ a:e testing", "php occ a:l", "php occ config:system:set trusted_domains 1 --value=server", "php occ log:manage --level 2", "php occ config:system:set csrf.disabled --value=true"]},
                 {"name": "owncloud-log-server", "image": "owncloud/ubuntu:20.04", "detach": true, "commands": ["tail -f /var/www/owncloud/server/data/owncloud.log"]},
                 {"name": "configure-app", "image": "owncloudci/php:7.4", "commands": ["cd /var/www/owncloud/server", "php occ encryption:enable", "php occ encryption:select-encryption-type masterkey --yes", "php occ config:list"]},
                 {"name": "wait-for-server", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it server:80 -t 600", "wait-for -it federated:80 -t 600"]},
                 {"name": "wait-for-email", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it email:8025 -t 600"]},
                 {"name": "fix-permissions", "image": "owncloudci/php:7.4", "commands": ["chown -R www-data /var/www/owncloud/server", "chown -R www-data /var/www/owncloud/federated", "chmod 777 /home/seluser/Downloads/"], "volumes": [{"name": "downloads", "path": "/home/seluser/Downloads/"}]},
                 {"name": "wait-for-selenium", "image": "owncloudci/wait-for:latest", "commands": ["wait-for -it selenium:4444 -t 600"]},
                 {
                   "name": "acceptance-tests",
                   "image": "owncloudci/php:7.4",
                   "environment": {
                     "ENCRYPTION_TYPE": "masterkey",
                     "TEST_SERVER_URL": "http://server",
                     "BEHAT_FILTER_TAGS": "@focus", "DOWNLOADS_DIRECTORY": "/var/www/owncloud/server/downloads", "BEHAT_SUITE": "webUIFiles", "SELENIUM_HOST": "selenium", "SELENIUM_PORT": "4444", "BROWSER": "chrome", "PLATFORM": "Linux", "MAILHOG_HOST": "email", "SCREENSHOTS": "true"}, "commands": ["touch /var/www/owncloud/saved-settings.sh", ". /var/www/owncloud/saved-settings.sh", "make test-acceptance-core-webui"], "volumes": [{"name": "downloads", "path": "/var/www/owncloud/server/downloads"}]}, {"name": "upload-screenshots", "image": "plugins/s3", "pull": "if-not-exists", "settings": {"bucket": {"from_secret": "cache_public_s3_bucket"}, "endpoint": {"from_secret": "cache_public_s3_server"}, "path_style": true, "source": "/var/www/owncloud/testrunner/apps//tests/acceptance/reports/screenshots/**/*", "strip_prefix": "/var/www/owncloud/testrunner/apps//tests/acceptance/reports/screenshots", "target": "/${DRONE_REPO}/${DRONE_BUILD_NUMBER}/screenshots"}, "environment": {"AWS_ACCESS_KEY_ID": {"from_secret": "cache_public_s3_access_key"}, "AWS_SECRET_ACCESS_KEY": {"from_secret": "cache_public_s3_secret_key"}}, "when": {"status": ["failure"], "event": ["pull_request"]}}, {"name": "build-github-comment", "image": "owncloud/ubuntu:20.04", "commands": ["cd /var/www/owncloud/testrunner/apps//tests/acceptance/reports/screenshots/", "echo \"<details><summary>:boom: The acceptance tests failed on retry. Please find the screenshots inside ...</summary>\\n\\n<p>\\n\\n\" >> /var/www/owncloud/testrunner/comments.file", "for f in *.png; do echo \"### $f\n\" '!'\"[$f]($CACHE_ENDPOINT/$CACHE_BUCKET/${DRONE_REPO}/${DRONE_BUILD_NUMBER}/screenshots/$f) \n\" \u003e\u003e /var/www/owncloud/testrunner/comments.file; done", "echo \"\n\u003c/p\u003e\u003c/details\u003e\" \u003e\u003e /var/www/owncloud/testrunner/comments.file", "more /var/www/owncloud/testrunner/comments.file"], "environment": {"TEST_CONTEXT": "webUIFiles", "CACHE_ENDPOINT": {"from_secret": "cache_public_s3_server"}, "CACHE_BUCKET": {"from_secret": "cache_public_s3_bucket"}}, "when": {"status": ["failure"], "event": ["pull_request"]}}, {"name": "build-github-comment-buildStop", "image": "owncloud/ubuntu:20.04", "commands": ["echo \":boom: Acceptance tests pipeline <strong>${DRONE_STAGE_NAME}</strong> failed. The build has been cancelled.\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}${DRONE_STAGE_NUMBER}\" >> /var/www/owncloud/testrunner/comments.file"], "when": {"status": ["failure"], "event": ["pull_request"]}}, {"name": "github-comment", "image": "thegeeklab/drone-github-comment:1", "pull": "if-not-exists", "settings": {"message": "/var/www/owncloud/testrunner/comments.file", "key": "pr-${DRONE_PULL_REQUEST}", "update": "true", "api_key": {"from_secret": "github_token"}}, "commands": ["if [ -s /var/www/owncloud/testrunner/comments.file ]; then echo 'Results for <strong>webUIFiles</strong> ${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}${DRONE_STAGE_NUMBER}/1' | cat - comments.file > temp && mv temp comments.file && /bin/drone-github-comment; fi"], "when": {"status": ["failure"], "event": ["pull_request"]}}], "services": [{"name": "mysql", "image": "mysql:8.0", "environment": {"MYSQL_USER": "owncloud", "MYSQL_PASSWORD": "owncloud", "MYSQL_DATABASE": "owncloud", "MYSQL_ROOT_PASSWORD": "owncloud"}, "command": ["--default-authentication-plugin=mysql_native_password"]}, {"name": "selenium", "image": "selenium/standalone-chrome-debug:3.141.59-oxygen", "environment": {"JAVA_OPTS": "-Dselenium.LOGGER.level=WARNING"}, "volumes": [{"name": "downloads", "path": "/home/seluser/Downloads"}]}, {"name": "email", "image": "mailhog/mailhog"}, {"name": "server", "image": "owncloudci/php:7.4", "environment": {"APACHE_WEBROOT": "/var/www/owncloud/server", "APACHE_LOGGING_PATH": "/dev/null"}, "commands": ["/usr/local/bin/apachectl -e debug -D FOREGROUND"]}, {"name": "federated", "image": "owncloudci/php:7.4", "environment": {"APACHE_WEBROOT": "/var/www/owncloud/federated", "APACHE_LOGGING_PATH": "/dev/null"}, "commands": ["/usr/local/bin/apachectl -e debug -D FOREGROUND"]}, {"name": "mysql-federated", "image": "mysql:8.0", "environment": {"MYSQL_USER": "owncloud", "MYSQL_PASSWORD": "owncloud", "MYSQL_DATABASE": "owncloud-federated", "MYSQL_ROOT_PASSWORD": "owncloud"}, "command": ["--default-authentication-plugin=mysql_native_password"]}], "depends_on": ["coding-standard-php7.4", "cancel-previous-builds", "check-starlark"], "trigger": {"cron": "nightly"}, "volumes": [{"name": "downloads", "temp": {}}]}
---
{"kind": "pipeline", "type": "docker", "name": "chat-notifications", "clone": {"disable": true}, "steps": [{"name": "notify-rocketchat", "image": "plugins/slack:1", "settings": {"webhook": {"from_secret": "private_rocketchat"}, "channel": "builds"}}], "depends_on": ["webUIFiles-flaky-chrome-mysql8.0-php7.4"], "trigger": {"ref": ["refs/tags/**", "refs/heads/master"], "status": ["success", "failure"]}}
